<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Upgrade Tree</title>
    <style>
        :root {
            --glow-primary: #64ffda;
            --glow-secondary: #4fd3a7;
            --glow-accent: #ff6b9d;
            --bg-dark: #0a0a2e;
            --bg-darker: #000000;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Courier New', monospace;
            background: radial-gradient(circle at center, var(--bg-dark) 0%, var(--bg-darker) 100%);
            color: var(--glow-primary);
            overflow-x: hidden;
            min-height: 100vh;
        }

        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }

        .title {
            text-align: center;
            font-size: 3rem;
            font-weight: bold;
            color: var(--glow-primary);
            text-shadow: 0 0 20px var(--glow-primary);
            margin-bottom: 10px;
            letter-spacing: 3px;
        }

        .subtitle {
            text-align: center;
            font-size: 1.2rem;
            color: var(--glow-secondary);
            margin-bottom: 40px;
            opacity: 0.8;
        }

        .main-stats { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }

        .stat-card {
            flex: 1;
            min-width: 250px;
            background: linear-gradient(135deg, rgba(100, 255, 218, 0.1) 0%, rgba(79, 211, 167, 0.1) 100%);
            border: 1px solid var(--glow-primary);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 1rem;
            color: var(--glow-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--glow-primary);
            text-shadow: 0 0 10px var(--glow-primary);
        }

        .buttons-row { display: flex; gap: 20px; margin-bottom: 40px; justify-content: center; flex-wrap: wrap; }

        .main-button {
            background: linear-gradient(135deg, var(--glow-primary) 0%, var(--glow-secondary) 100%);
            color: var(--bg-dark);
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(100, 255, 218, 0.3);
        }

        .main-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(100, 255, 218, 0.4); }
        .main-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap; }

        .tab {
            background: rgba(100, 255, 218, 0.1);
            border: 1px solid var(--glow-primary);
            color: var(--glow-primary);
            padding: 12px 24px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .tab.active {
            background: linear-gradient(135deg, var(--glow-primary) 0%, var(--glow-secondary) 100%);
            color: var(--bg-dark);
            box-shadow: 0 4px 15px rgba(100, 255, 218, 0.3);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .upgrades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .upgrade-card {
            background: linear-gradient(135deg, rgba(100, 255, 218, 0.05) 0%, rgba(79, 211, 167, 0.05) 100%);
            border: 1px solid var(--glow-primary);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .upgrade-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(100, 255, 218, 0.2); border-color: var(--glow-secondary); }
        .upgrade-card.affordable { border-color: var(--glow-secondary); background: linear-gradient(135deg, rgba(79, 211, 167, 0.1) 0%, rgba(100, 255, 218, 0.1) 100%); }
        .upgrade-card.maxed { opacity: 0.6; cursor: not-allowed; border-color: #666; }

        .upgrade-icon { font-size: 1.5rem; margin-bottom: 10px; display: block; }
        .upgrade-title { font-size: 1.2rem; font-weight: bold; color: var(--glow-primary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .upgrade-cost { color: var(--glow-accent); font-weight: bold; margin-bottom: 10px; font-size: 1rem; }
        .upgrade-description { color: #b0bec5; font-size: 0.9rem; line-height: 1.4; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--glow-primary) 0%, var(--glow-secondary) 100%);
            color: var(--bg-dark);
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(100, 255, 218, 0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show { transform: translateX(0); }

        .milestone {
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.1) 0%, rgba(100, 255, 218, 0.1) 100%);
            border: 1px solid var(--glow-accent);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .milestone.completed { border-color: var(--glow-secondary); background: linear-gradient(135deg, rgba(79, 211, 167, 0.1) 0%, rgba(100, 255, 218, 0.1) 100%); }
        .milestone-title { color: var(--glow-accent); font-weight: bold; margin-bottom: 5px; }
        .milestone.completed .milestone-title { color: var(--glow-secondary); }

        @media (max-width: 768px) {
            .title { font-size: 2rem; }
            .main-stats { flex-direction: column; }
            .upgrades-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <div class="container">
        <h1 class="title">COSMIC UPGRADE TREE</h1>
        <p class="subtitle">‚Ä¢ Idle Game ‚Ä¢</p>

        <div class="main-stats">
            <div class="stat-card"><div class="stat-label">Cosmic Energy</div><div class="stat-value" id="cosmicEnergy">1.00</div></div>
            <div class="stat-card"><div class="stat-label">Energy Generation</div><div class="stat-value" id="energyGeneration">1.00/sec</div></div>
            <div class="stat-card"><div class="stat-label">Universe Age</div><div class="stat-value" id="universeAge">0.00 eons</div></div>
        </div>

        <div class="buttons-row">
            <button class="main-button" id="bigBangReset">üåÄ Big Bang Reset</button>
            <button class="main-button" id="stellarCollapse" style="display:none;">‚≠ê Stellar Collapse</button>
            <button class="main-button" id="quantumLeap" style="display:none;">üîÆ Quantum Leap</button>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="cosmic-research">üî¨ Cosmic Research</div>
            <div class="tab" data-tab="dark-matter" style="display:none;">üåë Dark Matter</div>
            <div class="tab" data-tab="quantum" style="display:none;">üîÆ Quantum</div>
            <div class="tab" data-tab="dust">‚ú® Dust</div>
        </div>

        <div class="tab-content active" id="cosmic-research"><div class="upgrades-grid" id="cosmicUpgrades"></div></div>
        <div class="tab-content" id="dark-matter">
            <div class="stat-card" style="margin-bottom:20px;"><div class="stat-label">Dark Matter</div><div class="stat-value" id="darkMatter">0.00</div></div>
            <div class="upgrades-grid" id="darkMatterUpgrades"></div>
        </div>
        <div class="tab-content" id="quantum">
            <div class="stat-card" style="margin-bottom:20px;"><div class="stat-label">Quantum Leaps</div><div class="stat-value" id="quantumLeaps">0</div></div>
            <div class="upgrades-grid" id="quantumUpgrades"></div>
            <div id="milestones" style="margin-top:30px;"></div>
        </div>
        <div class="tab-content" id="dust">
            <div class="stat-card" style="margin-bottom:20px;"><div class="stat-label">Dust</div><div class="stat-value" id="dustAmount">0</div></div>
            <div class="stat-card" style="margin-bottom:20px;"><div class="stat-label">Collections</div><div class="stat-value" id="dustCollections">0</div></div>
            <div class="buttons-row" style="margin-bottom:30px;"><button class="main-button" id="collectDustBtn">‚ú® Collect Dust</button></div>
            <div class="upgrades-grid" id="dustUpgrades"></div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Game state
        let gameState = {
            cosmicEnergy: 1, energyGeneration: 1, universeAge: 0, darkMatter: 0, quantumLeaps: 0, totalQuantumLeaps: 0,
            upgrades: {}, milestones: [], dust: 0, lastDustCollection: 0, dustCollections: 0, bestCosmicEnergy: 1,
            bigBangClicks: 0, bigBangLastClick: 0, shown: {}
        };

        // Upgrade definitions - Compact format [id, name, icon, cost, effect, mult/formula, options]
        const upgradeDefaults = {cosmic: {costType: 'cosmicEnergy', maxLevel: 1}, dm: {costType: 'darkMatter', maxLevel: 1}, q: {costType: 'quantumLeaps', maxLevel: 1}, dust: {costType: 'dust', maxLevel: 1}};
        
        const cosmicRaw = [
            ['stellarFusion', 'Stellar Fusion', '‚≠ê', 10, 'Double energy generation', 2],
            ['galacticNetwork', 'Galactic Network', 'üåå', 25, 'Triple energy flow', 3],
            ['temporalAcceleration', 'Temporal Acceleration', '‚è∞', 75, 'Energy boost scales with age', s => s.universeAge/80+1],
            ['supernovaChain', 'Supernova Chain', 'üí•', 300, '8x energy boost', 8],
            ['cosmicResonance', 'Cosmic Resonance', 'üéµ', 2500, '3.5x energy from cosmic frequencies', 3.5],
            ['timeDistortionField', 'Time Distortion Field', 'üï≥Ô∏è', 12500, 'Temporal boost', s => s.cosmicEnergy>=1e10 ? Math.pow(s.universeAge/75,0.84)/1.2+1 : Math.pow(s.universeAge/50,0.95)+1, {showBoost:true}],
            ['nebulaHarvesting', 'Nebula Harvesting', '‚òÅÔ∏è', 50000, '3x energy from cosmic nebulae', 3],
            ['pulsarSync', 'Pulsar Synchronization', 'üåü', 150000, '3.5x energy from pulsar emissions', 3.5],
            ['quasarChanneling', 'Quasar Channeling', '‚òÄÔ∏è', 1500000, '2.5x energy boost from quasar power', 2.5],
            ['cosmicMultiplier', 'Cosmic Energy Multiplier', '‚úñÔ∏è', 5e6, 'x5 cosmic energy before 250M, then x3', s => s.cosmicEnergy<2.5e8?5:3],
            ['cosmicEnergyBoost', 'Cosmic Energy Boost', '‚ö°', 25e6, 'x2.5 cosmic energy', 2.5],
            ['energyBoostsDarkMatter', 'Energy Boosts Dark Matter', 'üåÄ', 75e6, 'Cosmic energy boosts dark matter', s => Math.pow(s.cosmicEnergy,0.08)/1.3+1, {showBoost:true, boostsDM:true}],
            ['timeBoostsDarkMatter', 'Time Boosts Dark Matter', '‚è≥', 15e7, 'Time boosts dark matter', s => s.cosmicEnergy>=1e10 ? Math.pow(s.universeAge/500,0.8)+1 : Math.pow(s.universeAge/450,0.87)+1, {showBoost:true, boostsDM:true}],
            ['energyBooststself', 'Energy Boosts Itself', '‚ôæÔ∏è', 8e8, 'Cosmic energy boosts itself', s => Math.pow(Math.pow(s.cosmicEnergy, s.upgrades.energyBoostBase?0.06:0.04),1.05)+1, {showBoost:true}],
            ['darkMatterBoost', 'Dark Matter Boost', 'üåë‚ö°', 2e9, 'x2 dark matter', 2, {boostsDM:true}],
            ['unlockQuantumForever', 'Unlock Quantum Leap Forever', 'üîÆ', 1e10, 'Permanently unlock quantum leap', null],
            ['cosmicEnergyTriple', 'Cosmic Energy Triple', '‚ö°¬≥', 15e12, 'x3 cosmic energy boost', 3],
            ['galacticEvents', 'Galactic Events', 'üå†', 1e14, '15% chance/sec for x30 energy', null],
            ['temporalSupercharge', 'Temporal Supercharge', '‚ö°‚è∞', 1e15, 'Time gain boosted', s => Math.pow(s.cosmicEnergy*s.darkMatter*Math.max(s.quantumLeaps,1),0.03)/1.11+1, {showBoost:true, boostsTime:true}],
            ['infinityEngine3', 'Infinity Engine.3', '‚ôæÔ∏è¬≥', 3e16, 'Infinity Engine boost also boosts quantum', s => s.upgrades.infinityEngine ? Math.pow(Math.pow(s.darkMatter,0.04)+1,0.2)*2 : 1, {showBoost:true, boostsQL:true}],
            ['awesomeBoost', 'AWESOME BOOST', 'üî•', 5e17, 'Cosmic energy boosts itself again', s => (Math.log10(Math.max(s.cosmicEnergy,1))+1)*(s.upgrades.improvementAgain?Math.log10(Math.max(s.cosmicEnergy,1))/2:1), {showBoost:true}],
            ['unoriginalAwesomeBoost', 'Unoriginal Awesome Boost', 'üî•üí≠', 8e19, 'Cosmic energy boost unoriginally', s => {let b=Math.log(Math.max(s.cosmicEnergy,1))/Math.log(100)/5+1; return s.upgrades.boostItElse?Math.pow(b,1.4):b;}, {showBoost:true, alsoBoostsDM:s=>s.upgrades.reallyFakeUpgrade}],
            ['quantumEnergy', 'Quantum Energy', 'üîÆ‚ö°', 5e20, 'x1.5 quantum leap gains', 1.5, {boostsQL:true}],
            ['priceLeap', 'Price Leap', 'üí∞üöÄ', 3e23, 'x1.5 energy, DM & quantum', 1.5, {boostsDM:true, boostsQL:true}],
            ['deserved', 'Deserved', 'üëë', 1e24, 'Energy multiplier ^1.04', null, {powerBoost:1.04}],
            ['thatsDefinitelyGood', "That's Definitely Good", 'üëç', 4e25, 'Cosmic energy ^1.02', s => Math.pow(s.cosmicEnergy,0.02), {showBoost:true}],
            ['nerfingNerf', 'Nerfing Nerf', '‚è∞üí™', 6e26, 'Age boosts itself', s => Math.pow(s.universeAge,0.08)+1, {showBoost:true, boostsTime:true}],
            ['reallyFakeUpgrade', 'Really Fake Upgrade', 'üî•üí≠üåë', 7e27, 'Unoriginal Boost also boosts DM', null],
            ['justGetItAgain', 'Just Get It Again', 'üí•üåë', 2e31, 'x5 dark matter', 5, {boostsDM:true}],
            ['allInOne', 'all in one', 'üåüüîÆ‚ö°', 1e34, 'Ultimate upgrade', null, {isAllInOne:true}],
            ['energyBoostBase', '+0.02 Energy Boost Base', '‚ôæÔ∏è‚ö°', 9e36, 'Energy Boosts Itself: ^0.06 base', null],
            ['hyperdimensionalCore', 'Hyperdimensional Core', 'üåÄ', 1e40, 'x10 cosmic energy', 10],
            ['youHaventGotSometimesQuantumLeapUpgradesAnyway', 'you havent got sometimes quantum leap upgrades anyway', 'üîÆü§∑', 2e44, 'x5 quantum leaps', 5, {boostsQL:true}],
            ['getItRn', 'get it rn', '‚ö°üî•', 3e46, 'x7 cosmic energy', 7],
            ['NICE', 'NICE!', 'üëå', 1e50, 'Energy ^1.05', null, {powerBoost:1.05}],
            ['theyAllAreAmazing', 'they all are amazing', 'üåüüí´', 8e52, 'x2 cosmic energy', 2],
            ['finallyWorthIt', 'finally worth it', 'üíØ', 1e54, 'x100 cosmic energy', 100],
            ['notWorthIt', 'not worth it', 'üåëüíØ', 1e57, 'x100 dark matter', 100, {boostsDM:true}]
        ];

        const darkMatterRaw = [
            ['darkEnergyInfusion', 'Dark Energy Infusion', 'üåë', 3, '1.5x cosmic energy', 1.5],
            ['recoverBoost', 'Recover Boost', 'üîÑ‚ö°', 2, 'x1.4 cosmic energy', 1.4],
            ['timeBooster', 'Time Booster', '‚è∞', 1.5, 'x2 universe age gain', 2, {boostsTime:true}],
            ['universalHarmony', 'Universal Harmony', 'üîÆ', 5, '1.3x DM & energy', 1.3, {boostsDM:true}],
            ['voidManipulation', 'Void Manipulation', '‚ö´', 12, '2x energy from void', 2],
            ['cosmicMultiplierDM', 'Cosmic Energy Multiplier', '‚úñÔ∏è', 20, 'x4 cosmic energy', 4],
            ['temporalDilation', 'Temporal Dilation Field', '‚è≥', 50, '2x energy + 2x age', 2, {boostsTime:true}],
            ['cosmicStorm', 'Cosmic Storm', '‚õàÔ∏è', 100, '3x energy from storms', 3],
            ['magnitudeScaling', 'Magnitude Scaling', 'üìè', 250, 'x1.15 per OOM achieved', s => Math.pow(1.15, Math.floor(Math.log10(Math.max(s.cosmicEnergy,1))))],
            ['researchSynergy', 'Research Synergy', 'üî¨', 500, 'x1.1 DM per research', s => Math.pow(1.1, Object.values(s.upgrades).filter(v=>v>0).length), {boostsDM:true, showBoost:true}],
            ['hyperspeedEvolution', 'Hyperspeed Evolution', 'üöÄ', 3000, '2x energy + 2x age', 2, {boostsTime:true}],
            ['infinityEngine', 'Infinity Engine', '‚ôæÔ∏è', 8000, 'DM boosts itself', s => Math.pow(s.darkMatter,0.04)+1, {boostsDM:true, showBoost:true}],
            ['darkMatterSurge', 'Dark Matter Surge', 'üåä', 40000, '2x energy final boost', 2],
            ['researchSynergy2', 'Research Synergy.2', 'üî¨‚ö°', 1e5, 'Research Synergy^0.5 boosts energy', s => s.upgrades.researchSynergy ? Math.pow(Math.pow(1.1,Object.values(s.upgrades).filter(v=>v>0).length),0.5) : 1, {showBoost:true}],
            ['magnitude2', 'Magnitude.2', 'üìê', 2e5, 'x1.05 per upgrade owned', s => Math.pow(1.05, Object.values(s.upgrades).reduce((a,b)=>a+b,0)), {showBoost:true}],
            ['synergisedEnergy', 'Synergised Energy', 'üîó', 5e5, 'DM boosts energy', s => Math.pow(s.darkMatter,0.08)*1.2+1, {showBoost:true}],
            ['improvisation', 'Improvisation', 'üé≠', 5e6, 'x5 cosmic energy', 5],
            ['galacticNetworkQ', 'Galactic Network?', 'üåå‚ùì', 5e7, 'x3 dark matter', 3, {boostsDM:true}],
            ['evenMoreNetwork', 'Even More Network', 'üååüåå', 5e8, 'x3 cosmic energy', 3],
            ['cootl', 'cootl', 'üî•', 2e9, 'x2 DM, x4 energy, x2 quantum', 4, {boostsDM:true, dmMult:2, boostsQL:true, qlMult:2}],
            ['deserved2', 'Deserved.2', 'üëë¬≤', 3e11, 'DM multiplier ^1.02', null, {powerBoostDM:1.02}],
            ['simple', 'Simple', '‚ö°', 1e12, 'x2 cosmic energy', 2],
            ['bruhTooUnoriginal', 'Bruh Too Unoriginal', 'üîóüåë', 15e12, 'x5 cosmic energy', 5],
            ['justGetIt', 'Just Get It', 'üí•', 69e12, 'x20 cosmic energy', 20],
            ['alr', 'alr', 'üëå', 2e15, 'x4 cosmic energy', 4],
            ['pushingUpToAllInOne', 'pushing up to all in one', '‚¨ÜÔ∏è', 1e16, 'x3 energy before 1e34', s => s.cosmicEnergy<1e34?3:1],
            ['leapTechnology', 'leap technology', 'üöÄüîÆ', 1e17, 'x2 quantum leaps', 2, {boostsQL:true}],
            ['cheapScaleButGood', 'cheap scale but good', 'üí∞‚ö°', 7e17, 'x2.5 cosmic energy', 2.5],
            ['continue', 'continue', 'üîÑ‚ö°', 6e20, 'Energy boosts itself again', s => Math.pow(s.cosmicEnergy,0.007)*2+1, {showBoost:true}],
            ['scaleReduce', 'Scale Reduce', 'üìâ‚öñÔ∏è', 2e23, 'Reduces milestone scaling', null],
            ['boost', 'boost', 'üöÄ', 1e23, 'x3 dark matter', 3, {boostsDM:true}],
            ['ifYouEverNeedIt', 'if you ever need it', 'üÜò‚ö°', 7e24, 'x3 cosmic energy', 3],
            ['awesomeDarkMatter', 'AWESOME!', 'üî•üåë', 1e25, 'Dark matter ^1.025', null, {powerBoostDM:1.025}]
        ];

        const quantumRaw = [
            ['quantumBoost1', 'Quantum Boost I', '‚ö°', 1, 'x1.5 energy & DM', 1.5, {boostsDM:true}],
            ['quantumBoost2', 'Quantum Boost II', '‚ö°‚ö°', 3, 'x3 cosmic energy', 3],
            ['darkMatterGen', 'Dark Matter Generation', 'üåë‚ö°', 5, 'Generate 1% DM from reset', null],
            ['unlockMilestones', 'Unlock Milestones', 'üèÜ', 10, 'Unlock milestone system', null],
            ['quantumBoost', 'Quantum Boost', 'üîÆ‚ö°', 20, 'x2 energy & DM', 2, {boostsDM:true}],
            ['quantumSelfBoost', 'Quantum Self-Enhancement', 'üîÑ', 40, 'QL boost themselves', s => s.quantumLeaps>0 ? Math.pow(s.quantumLeaps,0.1)*2+1 : 1, {showBoost:true, boostsQL:true}],
            ['quantumMechanics', 'Quantum Mechanics', '‚öõÔ∏è', 61, 'x2 DM & energy', 2, {boostsDM:true}],
            ['universalRecover', 'Universal Recover', 'üîÑ', 100, 'x10 energy till best record', 10, {untilBest:true}],
            ['energyLeap', 'Energy Leap', '‚ö°üöÄ', 210, 'x3 cosmic energy', 3],
            ['universalBuff', 'Universal Buff', 'üåüüí™', 400, 'x3 age & x2 energy', 2, {boostsTime:true, timeMult:3}],
            ['bestRecordResonance', 'Best Record Resonance', 'üèÜ', 500, 'x5 energy after best', 5, {afterBest:true}],
            ['greatOne', 'Great One', '‚≠ê', 1000, 'x2 energy & DM', 2, {boostsDM:true}],
            ['thisIsPeak', 'This is Peak', 'üî•‚≠ê', 1300, 'Energy boosts itself', s => Math.pow(s.cosmicEnergy,0.02)+1.2, {showBoost:true}],
            ['ohItWasSlow', 'Oh It Was Slow', 'üåëüöÄ', 2000, '7% DM gen & x2.5 QL', 2.5, {boostsQL:true}],
            ['youNeedTimewall', 'You Need Timewall', '‚è∞üõ°Ô∏è', 7000, 'x3 DM & energy', 3, {boostsDM:true}],
            ['actualTimewall', 'actual timewall', 'üõ°Ô∏è‚è∞', 30000, 'x3 DM & energy', 3, {boostsDM:true}],
            ['wasThatUpgradeTooOp', 'was that upgrade too op?', 'ü§îüí•', 60000, 'x2 energy & x1.5 DM', 2, {boostsDM:true, dmMult:1.5}],
            ['improvementAgain', 'improvement again', 'üî•‚ö°', 150000, 'Awesome Boost multiplied', null],
            ['improvableBoost', 'Improvable Boost', 'üìà', 400000, 'x3 energy + 2% per upgrade', s => 3 + Object.values(s.upgrades).reduce((a,b)=>a+b,0)*0.02, {showBoost:true}],
            ['dontGotAlotQuantumLeaps', 'dont got alot quantum leaps upgrade?', 'ü§∑‚Äç‚ôÇÔ∏è‚ö°', 2e6, 'x2 energy & DM', 2, {boostsDM:true}],
            ['boostItElse', 'boost it else', 'üöÄüìà', 2.5e6, '^1.4 unoriginal boost effect', null],
            ['energyFromSupernova', 'Energy from Supernova', 'üåüüí•', 3e7, 'x5 cosmic energy', 5],
            ['amazingQuantumLeaps', 'AMAZING!', 'üöÄüîÆ', 1e8, 'Quantum leaps ^1.015', null, {powerBoostQL:1.015}]
        ];

        const dustRaw = [
            ['sproutInspired', 'Inspired by sprouts', 'üå±', 1, 'Gain 2 dust', null, {givesInstantDust:2}],
            ['boost1', 'Boost I', '‚ö°', 8, 'x1.15 cosmic energy', 1.15],
            ['boost2', 'Boost II', '‚ö°‚ö°', 10, 'x1.15 cosmic energy', 1.15],
            ['boost11', 'Boost I.I', 'üåë‚ö°', 12, 'x1.3 dark matter', 1.3, {boostsDM:true}],
            ['boost3', 'Boost III', '‚ö°‚ö°‚ö°', 20, 'x1.15 cosmic energy', 1.15],
            ['greatboost1', 'Great Boost I', 'üîÆ‚ö°', 25, 'x1.3 quantum leaps', 1.3, {boostsQL:true}],
            ['improve', 'Improve Collection Time', '‚è∞', 30, 'Decrease to 50 min', null],
            ['thisCanBeGenerated', 'this can be generated?', '‚ú®üîß', 50, 'Generate 0.001 dust/sec', null]
        ];

        // Convert raw arrays to full upgrade objects
        const makeUpgrade = (raw, defaults) => raw.map(([id,name,icon,cost,effect,mult,opts={}]) => 
            ({...defaults, id, name, icon, cost, effect, mult, ...opts}));
        
        const cosmicUpgrades = makeUpgrade(cosmicRaw, upgradeDefaults.cosmic);
        const darkMatterUpgrades = makeUpgrade(darkMatterRaw, upgradeDefaults.dm);
        const quantumUpgrades = makeUpgrade(quantumRaw, upgradeDefaults.q);
        const dustUpgrades = makeUpgrade(dustRaw, upgradeDefaults.dust);
        const allUpgrades = [...cosmicUpgrades, ...darkMatterUpgrades, ...quantumUpgrades, ...dustUpgrades];

        // Milestone system
        const getMilestoneReq = (i) => {
            const base = [10,100,1e3,1e4,1e5,5e5,2e6,1e7,5e7];
            if (i < 9) return base[i];
            const scaleReduce = gameState.upgrades.scaleReduce;
            return scaleReduce ? 1.5e8 * Math.pow(3, i-9) : 5e8 * Math.pow(10, i-9);
        };

        const milestoneEffects = [
            'DM gen improved to 3%', 'x1.5 cosmic energy', 'x1.2 DM per milestone', 'x1.5 cosmic energy',
            'x2 quantum leaps', 'x1.5 dark matter', 'x1.2 QL per milestone', 'DM gen improved to 15%',
            'x1.5 cosmic energy', 'x2 energy & DM', 'x1.3 QL gain', 'x1.5 cosmic energy',
            'x2 dark matter', 'x1.5 all resources', 'x2 cosmic energy', 'x1.4 QL gain',
            'x3 dark matter', 'x2 all resources', 'x5 cosmic energy', 'x10 all resources'
        ];

        // Notification system
        const notifications = [
            {key: 'trillion', threshold: 1e12, resource: 'cosmicEnergy', msg: 'üåå First trillion energy'},
            {key: '100trillion', threshold: 1e14, resource: 'cosmicEnergy', msg: 'üî¨ 100 trillion Quantum unlocked'},
            {key: 'scientific', threshold: 1e15, resource: 'cosmicEnergy', msg: 'üî¨ Scientific notation enabled'},
            {key: 'ultimate', threshold: 1e40, resource: 'cosmicEnergy', msg: 'üåü ULTIMATE: 1e40 achieved'},
            {key: 'quantumSci', threshold: 1e15, resource: 'quantumLeaps', msg: 'üî¨ Quantum scientific notation'}
        ];

        // Format numbers
        function formatNumber(num, isQL = false) {
            if (!isFinite(num) || isNaN(num) || num === 0) return isQL ? '0' : '0.00';
            if (num < 0) return '-' + formatNumber(-num, isQL);
            
            const tiers = [{t:1e15,s:'',sci:true}, {t:1e12,s:'T'}, {t:1e9,s:'B'}, {t:1e6,s:'M'}, {t:1e3,s:'K'}, {t:0,s:''}];
            const tier = tiers.find(t => num >= t.t);
            
            if (tier.sci) return num.toExponential(2);
            const val = tier.t ? num/tier.t : num;
            return (isQL && num < 1000 ? Math.floor(val) : val.toFixed(2)) + tier.s;
        }

        // Show notification
        function showNotification(msg) {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 3000);
        }

        // Check notifications
        function checkNotifications() {
            notifications.forEach(n => {
                if (!gameState.shown[n.key] && gameState[n.resource] >= n.threshold) {
                    gameState.shown[n.key] = true;
                    showNotification(n.msg);
                }
            });
        }

        // Dust collection
        function getDustTime() { return gameState.upgrades.improve ? 50*60*1000 : 60*60*1000; }
        function getDustGain() { return 10 + Math.floor(gameState.dustCollections/10)*2; }
        function canCollectDust() { return Date.now() - gameState.lastDustCollection >= getDustTime(); }
        
        function collectDust() {
            if (!canCollectDust()) return showNotification('Dust not ready!');
            const gain = getDustGain();
            gameState.dust += gain;
            gameState.dustCollections++;
            gameState.lastDustCollection = Date.now();
            showNotification(`‚ú® Collected ${gain} Dust! (#${gameState.dustCollections})`);
            updateDisplay();
        }

        function updateDustButton() {
            const btn = document.getElementById('collectDustBtn');
            if (canCollectDust()) {
                btn.disabled = false;
                btn.textContent = `‚ú® Collect ${getDustGain()} Dust (Ready!)`;
            } else {
                btn.disabled = true;
                const remaining = getDustTime() - (Date.now() - gameState.lastDustCollection);
                const h = Math.floor(remaining/3600000), m = Math.floor((remaining%3600000)/60000), s = Math.floor((remaining%60000)/1000);
                btn.textContent = `‚ú® Collect Dust (${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')})`;
            }
        }

        // Calculate multipliers - OPTIMIZED VERSION
        function calculateMultipliers() {
            let mults = {energy: 1, darkMatter: 1, quantum: 1, time: 1};
            const s = gameState;

            // Process all upgrades with simple multipliers
            allUpgrades.forEach(u => {
                const lvl = s.upgrades[u.id] || 0;
                if (lvl === 0) return;

                if (typeof u.mult === 'number') {
                    mults.energy *= Math.pow(u.mult, lvl);
                    if (u.boostsDM) mults.darkMatter *= Math.pow(u.dmMult || u.mult, lvl);
                    if (u.boostsQL) mults.quantum *= Math.pow(u.qlMult || u.mult, lvl);
                    if (u.boostsTime) mults.time *= Math.pow(u.timeMult || u.mult, lvl);
                } else if (typeof u.mult === 'function') {
                    const boost = u.mult(s);
                    if (u.boostsDM || u.alsoBoostsDM && u.alsoBoostsDM(s)) mults.darkMatter *= boost;
                    if (u.boostsQL) mults.quantum *= boost;
                    if (u.boostsTime) mults.time *= boost;
                    if (!u.boostsDM && !u.boostsQL && !u.boostsTime) mults.energy *= boost;
                }

                // Special cases
                if (u.untilBest && s.cosmicEnergy >= s.bestCosmicEnergy) mults.energy /= u.mult;
                if (u.afterBest && s.cosmicEnergy >= s.bestCosmicEnergy) mults.energy *= u.mult;
                if (u.givesInstantDust && !s[`received_${u.id}`]) {
                    s.dust += u.givesInstantDust;
                    s[`received_${u.id}`] = true;
                }
            });

            // Milestones
            let mCount = s.milestones.filter(m=>m).length;
            if (mCount > 1) mults.energy *= Math.pow(1.5, mCount - 1);
            if (mCount >= 3) mults.darkMatter *= Math.pow(1.2, mCount - 1);
            if (mCount >= 6) mults.darkMatter *= 1.5;
            if (mCount >= 7) mults.quantum *= Math.pow(1.2, mCount - 4);
            if (mCount >= 5) mults.quantum *= 2;

            // All-in-one upgrade (complex multi-effect)
            if (s.upgrades.allInOne) {
                mults.energy *= 1.2; mults.darkMatter *= 1.2; mults.quantum *= 1.2;
                const tBoost = Math.pow(s.universeAge/20000, 0.55)/9+1;
                mults.energy *= tBoost; mults.darkMatter *= tBoost; mults.quantum *= tBoost; mults.time *= tBoost;
                mults.energy *= Math.pow(s.cosmicEnergy, 0.005)+1;
                mults.darkMatter *= Math.pow(s.darkMatter, 0.005)+1;
                mults.quantum *= Math.pow(Math.max(s.quantumLeaps,1), 0.006)+1;
                mults.energy = Math.pow(mults.energy, 1.005);
                mults.darkMatter = Math.pow(mults.darkMatter, 1.005);
                mults.quantum = Math.pow(mults.quantum, 1.005);
                const oomBonus = Math.floor(Math.log10(Math.max(s.cosmicEnergy,1))/2);
                if (oomBonus > 0) { mults.darkMatter *= Math.pow(1.01, oomBonus); mults.quantum *= Math.pow(1.01, oomBonus); }
                mults.energy *= s.cosmicEnergy < s.bestCosmicEnergy ? 1.1 : 1.2;
                const ageOOMs = Math.log10(Math.max(s.universeAge, 1));
                mults.time *= Math.pow(1.03, ageOOMs);
                const ageBoost = Math.pow(s.cosmicEnergy*s.darkMatter*Math.max(s.quantumLeaps,1), 0.001)+1;
                mults.time *= ageBoost;
            }

            // Power boosts
            if (s.upgrades.deserved) mults.energy = Math.pow(mults.energy, 1.04);
            if (s.upgrades.NICE) mults.energy = Math.pow(mults.energy, 1.05);
            if (s.upgrades.deserved2) mults.darkMatter = Math.pow(mults.darkMatter, 1.02);
            if (s.upgrades.awesomeDarkMatter) mults.darkMatter = Math.pow(mults.darkMatter, 1.025);
            if (s.upgrades.amazingQuantumLeaps) mults.quantum = Math.pow(mults.quantum, 1.015);

            // Age dividers
            if (s.universeAge >= 1000) mults.time /= Math.pow(Math.pow(s.universeAge, 0.21), 0.95) + 1;
            if (s.universeAge >= 1200) mults.time /= 1.5;

            return mults;
        }

        // Calculate reset gains
        function calcDarkMatterGain() {
            const base = Math.pow(gameState.cosmicEnergy, 0.13) + 1;
            return base * calculateMultipliers().darkMatter;
        }

        function calcQuantumLeapGain() {
            const base = Math.pow(gameState.darkMatter, 0.1) + 1;
            return Math.floor(base * calculateMultipliers().quantum);
        }

        // Perform resets - UNIFIED FUNCTION
        function performReset(type) {
            const s = gameState;
            const now = Date.now();

            if (type === 'bigBang') {
                if (now - s.bigBangLastClick > 10000) s.bigBangClicks = 0;
                s.bigBangClicks++;
                s.bigBangLastClick = now;
                if (s.bigBangClicks < 5) return showNotification(`${5-s.bigBangClicks} more clicks needed!`);
                
                s.bigBangClicks = 0;
                const dustUpgradeIds = dustUpgrades.map(u => u.id);
                const preserved = {};
                dustUpgradeIds.forEach(id => { if (s.upgrades[id]) preserved[id] = s.upgrades[id]; });
                
                Object.assign(s, {cosmicEnergy:1, energyGeneration:1, universeAge:0, darkMatter:0, quantumLeaps:0, totalQuantumLeaps:0, upgrades:preserved, milestones:[]});
                
                document.querySelector('[data-tab="dark-matter"]').style.display = 'none';
                document.querySelector('[data-tab="quantum"]').style.display = 'none';
                document.getElementById('stellarCollapse').style.display = 'none';
                document.getElementById('quantumLeap').style.display = 'none';
                
                showNotification('üåÄ Big Bang Reset Complete!');
            }

            if (type === 'stellar') {
                if (s.cosmicEnergy < 500000) return showNotification('Need 500K energy');
                const gain = calcDarkMatterGain();
                s.darkMatter += gain;
                s.cosmicEnergy = 1; s.energyGeneration = 1; s.universeAge = 0;
                cosmicUpgrades.forEach(u => s.upgrades[u.id] = 0);
                showNotification(`‚≠ê Stellar Collapse! +${formatNumber(gain)} Dark Matter`);
            }

            if (type === 'quantum') {
                if (s.darkMatter < 50000) return showNotification('Need 50K dark matter');
                const gain = calcQuantumLeapGain();
                s.quantumLeaps += gain;
                s.totalQuantumLeaps += gain;
                s.cosmicEnergy = 1; s.energyGeneration = 1; s.universeAge = 0; s.darkMatter = 0;
                [...cosmicUpgrades, ...darkMatterUpgrades].forEach(u => s.upgrades[u.id] = 0);
                if (s.upgrades.scaleReduce) s.upgrades.scaleReduce = 1;
                updateMilestones();
                showNotification(`üîÆ Quantum Leap! +${formatNumber(gain, true)} QL`);
            }

            updateDisplay();
            renderAllUpgrades();
        }

        // Buy upgrade
        function buyUpgrade(upgrade) {
            const s = gameState;
            const lvl = s.upgrades[upgrade.id] || 0;
            if (lvl >= upgrade.maxLevel) return;

            const currency = s[upgrade.costType === 'cosmicEnergy' ? 'cosmicEnergy' : upgrade.costType === 'darkMatter' ? 'darkMatter' : upgrade.costType === 'dust' ? 'dust' : 'quantumLeaps'];
            if (currency < upgrade.cost) return;

            s[upgrade.costType === 'cosmicEnergy' ? 'cosmicEnergy' : upgrade.costType === 'darkMatter' ? 'darkMatter' : upgrade.costType === 'dust' ? 'dust' : 'quantumLeaps'] -= upgrade.cost;
            s.upgrades[upgrade.id] = lvl + 1;

            if (upgrade.id === 'unlockMilestones') updateMilestones();
            
            showNotification(`‚ú® Purchased ${upgrade.name}!`);
            updateDisplay();
            renderAllUpgrades();
        }

        // Game loop
        function gameLoop() {
            const s = gameState;
            s.bestCosmicEnergy = Math.max(s.bestCosmicEnergy, s.cosmicEnergy);
            
            const mults = calculateMultipliers();
            
            // Galactic Events
            let eventBoost = 1;
            if (s.upgrades.galacticEvents && Math.random() < 0.15) {
                eventBoost = 30;
                showNotification('üå† GALACTIC EVENT: x30 Energy!');
            }

            // Generate resources
            const energyGain = Math.min(s.energyGeneration * mults.energy * eventBoost / 10, 1e100);
            const ageGain = Math.min(1 * mults.time / 10, 1000);
            
            s.cosmicEnergy = Math.min(s.cosmicEnergy + energyGain, 1e308);
            s.universeAge = Math.min(s.universeAge + ageGain, 1e100);

            // Passive dark matter generation
            if (s.upgrades.darkMatterGen) {
                const potential = Math.pow(s.cosmicEnergy, 0.13) + 1;
                let genRate = 0.01;
                const mCount = s.milestones.filter(m=>m).length;
                if (mCount >= 1) genRate = 0.03;
                if (s.upgrades.ohItWasSlow) genRate = 0.07;
                if (mCount >= 8) genRate = 0.15;
                s.darkMatter += potential * genRate * mults.darkMatter / 10;
            }

            // Passive dust generation
            if (s.upgrades.thisCanBeGenerated) s.dust += 0.0001;

            checkNotifications();
            updateDisplay();
        }

        // Update display
        function updateDisplay() {
            const s = gameState;
            document.getElementById('cosmicEnergy').textContent = formatNumber(s.cosmicEnergy);
            document.getElementById('energyGeneration').textContent = formatNumber(s.energyGeneration * calculateMultipliers().energy) + '/sec';
            document.getElementById('universeAge').textContent = formatNumber(s.universeAge) + ' eons';
            document.getElementById('darkMatter').textContent = formatNumber(s.darkMatter);
            document.getElementById('quantumLeaps').textContent = formatNumber(s.quantumLeaps, true);
            document.getElementById('dustAmount').textContent = formatNumber(s.dust);
            document.getElementById('dustCollections').textContent = s.dustCollections;
            updateDustButton();

            // Show/hide buttons
            const stellarBtn = document.getElementById('stellarCollapse');
            const quantumBtn = document.getElementById('quantumLeap');
            
            if (s.cosmicEnergy >= 1000) {
                stellarBtn.style.display = 'block';
                document.querySelector('[data-tab="dark-matter"]').style.display = 'block';
                stellarBtn.disabled = s.cosmicEnergy < 500000;
                stellarBtn.textContent = s.cosmicEnergy >= 500000 ? `‚≠ê Stellar Collapse (${formatNumber(calcDarkMatterGain())} DM)` : '‚≠ê Need 500K Energy';
            }

            if (s.darkMatter >= 100 || s.upgrades.unlockQuantumForever) {
                quantumBtn.style.display = 'block';
                document.querySelector('[data-tab="quantum"]').style.display = 'block';
                quantumBtn.disabled = s.darkMatter < 50000;
                quantumBtn.textContent = s.darkMatter >= 50000 ? `üîÆ Quantum Leap (${formatNumber(calcQuantumLeapGain(), true)} QL)` : 'üîÆ Need 50K DM';
            }
        }

        // Render upgrades - OPTIMIZED WITH EVENT DELEGATION
        function renderUpgrades(containerId, upgrades) {
            const s = gameState;
            const container = document.getElementById(containerId);
            const currencyMap = {cosmicEnergy: s.cosmicEnergy, darkMatter: s.darkMatter, quantumLeaps: s.quantumLeaps, dust: s.dust};
            
            container.innerHTML = upgrades.map(u => {
                const lvl = s.upgrades[u.id] || 0;
                const currency = currencyMap[u.costType];
                const canAfford = currency >= u.cost && lvl < u.maxLevel;
                const isMaxed = lvl >= u.maxLevel;
                
                let boostText = '';
                if (u.showBoost && lvl > 0 && typeof u.mult === 'function') {
                    boostText = ` <span style="color:#4fd3a7">(Current: x${formatNumber(u.mult(s))})</span>`;
                }
                
                return `<div class="upgrade-card ${canAfford?'affordable':''} ${isMaxed?'maxed':''}" data-id="${u.id}">
                    <span class="upgrade-icon">${u.icon}</span>
                    <div class="upgrade-title">${u.name}${lvl>0?'‚úì':''}</div>
                    <div class="upgrade-cost">${isMaxed?'OWNED':`${formatNumber(u.cost)} ${u.costType.replace('cosmicEnergy','Energy').replace('darkMatter','DM').replace('quantumLeaps','QL').replace('dust','Dust')}`}</div>
                    <div class="upgrade-description">${u.effect}${boostText}</div>
                </div>`;
            }).join('');
        }

        function renderAllUpgrades() {
            renderUpgrades('cosmicUpgrades', cosmicUpgrades);
            renderUpgrades('darkMatterUpgrades', darkMatterUpgrades);
            renderUpgrades('quantumUpgrades', quantumUpgrades);
            renderUpgrades('dustUpgrades', dustUpgrades);
        }

        // Update milestones
        function updateMilestones() {
            if (!gameState.upgrades.unlockMilestones) return;
            const container = document.getElementById('milestones');
            const s = gameState;
            
            container.innerHTML = '<h3 style="color:#64ffda;margin-bottom:20px;text-align:center;">üèÜ MILESTONES</h3>' +
                Array.from({length: 20}, (_, i) => {
                    const req = getMilestoneReq(i);
                    const completed = s.totalQuantumLeaps >= req;
                    if (!s.milestones[i]) s.milestones[i] = completed;
                    return `<div class="milestone ${completed?'completed':''}">
                        <div class="milestone-title">Milestone ${i+1} ${completed?'‚úì':''}</div>
                        <div>Requirement: ${formatNumber(req)} total QL</div>
                        <div>Effect: ${milestoneEffects[i]}</div>
                        <div>Progress: ${formatNumber(s.totalQuantumLeaps)}/${formatNumber(req)}</div>
                    </div>`;
                }).join('');
        }

        // Save/Load
        function saveGame() {
            try {
                localStorage.setItem('cosmicEvolution', JSON.stringify({...gameState, lastSaveTime: Date.now()}));
            } catch(e) {}
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('cosmicEvolution');
                if (!saved) return;
                
                const savedState = JSON.parse(saved);
                const offlineTime = Date.now() - (savedState.lastSaveTime || Date.now());
                gameState = {...gameState, ...savedState};
                
                if (gameState.lastDustCollection === 0) gameState.lastDustCollection = Date.now() - getDustTime();
                
                if (offlineTime > 5000) {
                    const offlineSec = offlineTime / 1000;
                    const mults = calculateMultipliers();
                    const offlineEnergy = (gameState.energyGeneration * mults.energy * offlineSec) / 5;
                    const offlineAge = (offlineSec * mults.time) / 5;
                    
                    gameState.cosmicEnergy += offlineEnergy;
                    gameState.universeAge += offlineAge;
                    
                    if (gameState.upgrades.darkMatterGen) {
                        const potential = Math.pow(gameState.cosmicEnergy, 0.13) + 1;
                        let genRate = 0.01;
                        const mCount = gameState.milestones.filter(m=>m).length;
                        if (mCount >= 1) genRate = 0.03;
                        if (gameState.upgrades.ohItWasSlow) genRate = 0.07;
                        if (mCount >= 8) genRate = 0.15;
                        gameState.darkMatter += (potential * genRate * mults.darkMatter * offlineSec) / 5;
                    }
                    
                    if (gameState.upgrades.thisCanBeGenerated) gameState.dust += 0.001 * offlineSec;
                    
                    const hrs = Math.floor(offlineTime/3600000), mins = Math.floor((offlineTime%3600000)/60000);
                    showNotification(`Welcome back Offline ${hrs}h ${mins}m. Gained ${formatNumber(offlineEnergy)} Energy`);
                }
                
                updateDisplay();
                renderAllUpgrades();
                updateMilestones();
            } catch(e) {}
        }

        // Initialize
        function init() {
            // Create stars
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = star.style.height = (Math.random() * 3 + 1) + 'px';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }

            // Event listeners
            document.getElementById('bigBangReset').onclick = () => performReset('bigBang');
            document.getElementById('stellarCollapse').onclick = () => performReset('stellar');
            document.getElementById('quantumLeap').onclick = () => performReset('quantum');
            document.getElementById('collectDustBtn').onclick = collectDust;

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                };
            });

            // Event delegation for upgrade clicks
            document.querySelectorAll('.upgrades-grid').forEach(grid => {
                grid.onclick = (e) => {
                    const card = e.target.closest('.upgrade-card');
                    if (!card || card.classList.contains('maxed')) return;
                    const upgrade = allUpgrades.find(u => u.id === card.dataset.id);
                    if (upgrade) buyUpgrade(upgrade);
                };
            });

            loadGame();
            renderAllUpgrades();
            updateDisplay();
            updateMilestones();

            // Start loops
            setInterval(gameLoop, 100);
            setInterval(renderAllUpgrades, 5000); // Update UI every 5 seconds instead of 1
            setInterval(saveGame, 10000);
        }

        window.onload = init;
    </script>
</body>
</html>
